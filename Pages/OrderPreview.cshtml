@page
@model BetfairReplicator.Pages.OrderPreviewModel
@{
    ViewData["Title"] = "Ordine (preview)";
}

<h1>Ordine (preview)</h1>
<p class="text-muted">Qui NON inviamo nulla: mostriamo solo lo stake per account e il JSON pronto.</p>

@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<form method="post" class="mb-4">
    @Html.AntiForgeryToken()
    <div class="row g-2">
        <div class="col-12 col-md-4">
            <label class="form-label">MarketId</label>
            <input class="form-control" name="MarketId" value="@Model.MarketId" placeholder="es. 1.23456789" required />
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">SelectionId</label>
            @if (Model.Runners != null && Model.Runners.Count > 0)
            {
                <select class="form-select" name="SelectionId" required>
                    @foreach (var r in Model.Runners)
                    {
                        <option value="@r.SelectionId" selected="@(Model.SelectionId == r.SelectionId)">
                            @{
                                var q = Model.QuotesBySelection.ContainsKey(r.SelectionId) ? Model.QuotesBySelection[r.SelectionId] : (null, null);
                                var backTxt = q.Back?.ToString("0.00") ?? "-";
                                var layTxt = q.Lay?.ToString("0.00") ?? "-";
                            }
                            @r.Name — BACK @backTxt / LAY @layTxt
                        </option>
                    }
                </select>

                @if (!string.IsNullOrWhiteSpace(Model.QuotesInfo))
                {
                    <div class="form-text">@Model.QuotesInfo</div>
                }

            }
            else
            {
                <input class="form-control" type="number" name="SelectionId" value="@Model.SelectionId" placeholder="SelectionId" required />
                <div class="form-text">Nessun runner caricato: controlla MarketId o token collegato.</div>
            }

        </div>

        <div class="col-6 col-md-2">
            <label class="form-label">Side</label>
            <select class="form-select" name="Side">
                <option value="BACK" selected="@(Model.Side == "BACK")">BACK</option>
                <option value="LAY" selected="@(Model.Side == "LAY")">LAY</option>
            </select>
        </div>

        <div class="col-6 col-md-2">
            <label class="form-label">Price</label>
            <input class="form-control" type="number" step="0.01" min="1.01" name="Price" value="@Model.Price" required />
        </div>

        <div class="col-6 col-md-2">
            <label class="form-label">Stake %</label>
            <input class="form-control" type="number" step="0.1" min="0.1" max="100" name="StakePercent" value="@Model.StakePercent" required />
        </div>

        <div class="col-6 col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100" type="submit" asp-page-handler="Preview">Genera preview</button>
        </div>

        <div class="col-6 col-md-2 d-flex align-items-end">
            <button class="btn btn-danger w-100"
                    type="submit"
                    asp-page-handler="Send"
                    onclick="return confirm('CONFERMI INVIO ORDINE REALE su tutti gli account collegati?');">
                INVIA ORDINE
            </button>
        </div>

    </div>
</form>

@if (Model.Rows?.Any() == true)
{
    <table class="table">
        <thead>
            <tr>
                <th>Account</th>
                <th>Saldo</th>
                <th>Stake</th>
                <th>Stato</th>
                <th>BetId</th>
                <th>Live</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in Model.Rows)
            {
                <tr>
                    <td>@r.DisplayName</td>
                    <td>@(r.Balance?.ToString("0.00") ?? "-")</td>
                    <td>@(r.Stake?.ToString("0.00") ?? "-")</td>
                    <td>@r.Status</td>
                    <td>@(r.BetId ?? "-")</td>
<td>
    @if (!string.IsNullOrWhiteSpace(r.BetId))
    {
        <span class="order-live"
              data-account="@r.DisplayName"
              data-betid="@r.BetId">
            …
        </span>

        <div class="small text-muted">
            M:<span class="m"></span> R:<span class="r"></span> Avg:<span class="a"></span>
        </div>

        <button type="button"
                class="btn btn-sm btn-outline-danger mt-1 btn-cancel"
                data-account="@r.DisplayName"
                data-betid="@r.BetId">
            Cancella ordine
        </button>
    }
    else
    {
        <span>-</span>
    }
</td>


                </tr>

                @if (!string.IsNullOrWhiteSpace(r.JsonRpcPreview))
                {
                    <tr>
                        <td colspan="4">
                            <details>
                                <summary>JSON-RPC preview (@r.DisplayName)</summary>
                                <pre class="mt-2">@r.JsonRpcPreview</pre>
                            </details>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

<a class="btn btn-secondary" asp-page="/Funds">Indietro</a>
@section Scripts {
    <script>
        (async function () {
            const REFRESH_MS = 2500;

            async function refreshOne(el) {
                const account = el.dataset.account;
                const betId = el.dataset.betid;

                try {
                    const url = `/OrderPreview?handler=OrderStatus&account=${encodeURIComponent(account)}&betId=${encodeURIComponent(betId)}`;
                    const res = await fetch(url, { cache: "no-store" });
                    const data = await res.json();

                    if (!data.ok) {
                        el.textContent = data.error || "ERR";
                        return;
                    }

                    el.textContent = data.status || "-";

                    const wrap = el.parentElement;
                    if (!wrap) return;

                    const m = wrap.querySelector(".m");
                    const r = wrap.querySelector(".r");
                    const a = wrap.querySelector(".a");

                    if (m) m.textContent = (data.sizeMatched ?? "-");
                    if (r) r.textContent = (data.sizeRemaining ?? "-");
                    if (a) a.textContent = (data.avgPriceMatched ?? "-");
                } catch {
                    el.textContent = "NET";
                }
            }

            async function refreshAll() {
                const els = document.querySelectorAll(".order-live");
                for (const el of els) await refreshOne(el);
            }
function getAntiForgeryToken() {
    const el = document.querySelector('input[name="__RequestVerificationToken"]');
    return el ? el.value : "";
}

async function cancelOrder(account, betId) {
    const token = getAntiForgeryToken();

    const form = new URLSearchParams();
    form.append("account", account);
    form.append("betId", betId);

    const res = await fetch(`/OrderPreview?handler=CancelOrder`, {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "RequestVerificationToken": token
        },
        body: form.toString()
    });

    return await res.json();
}

function bindCancelButtons() {
    document.querySelectorAll(".btn-cancel").forEach(btn => {
        if (btn.dataset.bound === "1") return;
        btn.dataset.bound = "1";

        btn.addEventListener("click", async () => {
            const account = btn.dataset.account;
            const betId = btn.dataset.betid;

            if (!confirm(`Confermi cancellazione ordine?\nAccount: ${account}\nBetId: ${betId}`))
                return;

            btn.disabled = true;
            try {
                const data = await cancelOrder(account, betId);
                if (!data.ok) {
                    alert(data.error || "Errore cancellazione");
                }

                // refresh immediato dopo cancel
                await refreshAll();
            } finally {
                btn.disabled = false;
            }
        });
    });
}

            bindCancelButtons();
await refreshAll();
setInterval(refreshAll, REFRESH_MS);

        })();
    </script>
}
