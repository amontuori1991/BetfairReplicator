@page
@model BetfairReplicator.Pages.OrderPreviewModel
@{
    ViewData["Title"] = "Ordine (preview)";
}
<style>
    /* Forza colori leggibili SOLO nella modal di invio ordine */
    #sendConfirmModal .modal-content,
    #sendConfirmModal .modal-title,
    #sendConfirmModal .modal-body,
    #sendConfirmModal .modal-body * {
        color: #212529 !important;
    }

    #sendConfirmModal .modal-content,
    #sendConfirmModal .modal-body,
    #sendConfirmModal .modal-title {
        opacity: 1 !important;
    }

    /* === Anti-errore stile banca === */
    #sendConfirmModal .bank-header {
        display: flex;
        align-items: center;
        gap: .6rem;
    }

    #sendConfirmModal .ball {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        background: rgba(13,110,253,.12); /* blu soft */
        border: 1px solid rgba(13,110,253,.20);
        font-size: 18px;
        line-height: 1;
    }

    #sendConfirmModal .bank-summary {
        border: 1px solid rgba(0,0,0,.08);
        background: rgba(0,0,0,.02);
        border-radius: 12px;
        padding: 12px 12px;
    }

    #sendConfirmModal .bank-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        padding: 6px 0;
        border-bottom: 1px dashed rgba(0,0,0,.08);
    }

        #sendConfirmModal .bank-row:last-child {
            border-bottom: none;
        }

    #sendConfirmModal .bank-k {
        font-weight: 600;
        color: rgba(33,37,41,.80);
        white-space: nowrap;
    }

    #sendConfirmModal .bank-v {
        font-weight: 700;
        text-align: right;
    }

    /* Badge BACK/LAY */
    #sendConfirmModal .badge-side {
        font-weight: 700;
        letter-spacing: .3px;
        padding: .45rem .6rem;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: .35rem;
    }

    #sendConfirmModal .badge-back {
        background: rgba(13,110,253,.12);
        color: #0d6efd;
        border: 1px solid rgba(13,110,253,.25);
    }

    #sendConfirmModal .badge-lay {
        background: rgba(220,53,69,.12);
        color: #dc3545;
        border: 1px solid rgba(220,53,69,.25);
    }

    /* Pulsante invio: aspetto "banca" */
    #sendConfirmModal #btnConfirmSend[disabled] {
        opacity: .55;
        cursor: not-allowed;
    }

    #sendConfirmModal .risk-box {
        border-radius: 12px;
        border: 1px solid rgba(255,193,7,.35);
        background: rgba(255,193,7,.14);
        padding: 10px 12px;
    }
</style>

<h1>Ordine (preview)</h1>
<p class="text-muted">
    Preview: genera lo stake/importo per account e il JSON pronto. Con "INVIA ORDINE" piazza davvero l'ordine su tutti gli account collegati.
</p>

@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<form method="post" class="mb-4">
    @Html.AntiForgeryToken()

    <!-- ROW 1: mercato + selezione + side + price -->
    <div class="row g-2">
        <div class="col-12 col-md-4">
            <label class="form-label">MarketId</label>
            <input class="form-control" name="MarketId" value="@Model.MarketId" placeholder="es. 1.23456789" required />
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">SelectionId</label>
            @if (Model.Runners != null && Model.Runners.Count > 0)
            {
                <select class="form-select" name="SelectionId" required>
                    @foreach (var r in Model.Runners)
                    {
                        <option value="@r.SelectionId" selected="@(Model.SelectionId == r.SelectionId)">
                            @{
                                var q = Model.QuotesBySelection.ContainsKey(r.SelectionId)
                                    ? Model.QuotesBySelection[r.SelectionId]
                                    : (null, null);
                                var backTxt = q.Back?.ToString("0.00") ?? "-";
                                var layTxt = q.Lay?.ToString("0.00") ?? "-";
                            }
                            @r.Name — BACK @backTxt / LAY @layTxt
                        </option>
                    }
                </select>

                @if (!string.IsNullOrWhiteSpace(Model.QuotesInfo))
                {
                    <div class="form-text">@Model.QuotesInfo</div>
                }
            }
            else
            {
                <input class="form-control" type="number" name="SelectionId" value="@Model.SelectionId" placeholder="SelectionId" required />
                <div class="form-text">Nessun runner caricato: controlla MarketId o token collegato.</div>
            }
        </div>

        <div class="col-6 col-md-2">
            <label class="form-label">Side</label>
            <select class="form-select" name="Side" id="sideSelect">
                <option value="BACK" selected="@(Model.Side == "BACK")">BACK</option>
                <option value="LAY" selected="@(Model.Side == "LAY")">LAY</option>
            </select>
            <div class="form-text">BACK = punta (importo fisso). LAY = banca (stake %).</div>
        </div>

        <div class="col-6 col-md-2">
            <label class="form-label">Price</label>
            <input class="form-control" type="number" step="0.01" min="1.01" name="Price" value="@Model.Price" required />
        </div>
    </div>

    <!-- ROW 2: stake + bottoni -->
    <div class="row g-2 mt-1">
        <!-- LAY: stake percent -->
        <div class="col-12 col-md-3" id="grpStakePercent">
            <label class="form-label">Stake % (solo LAY)</label>
            <input class="form-control" type="number" step="0.1" min="0.1" max="100" name="StakePercent" value="@Model.StakePercent" />
            <div class="form-text">Usato solo se Side=LAY.</div>
        </div>

        <!-- BACK: stake euro -->
        <div class="col-12 col-md-3" id="grpBackStakeEuro">
            <label class="form-label">Importo BACK € (solo BACK)</label>
            <input class="form-control" type="number" step="0.01" min="1.00" name="BackStakeEuro" value="@(Model.BackStakeEuro?.ToString("0.00") ?? "")" />
            <div class="form-text">Min 1€. Usato solo se Side=BACK.</div>
        </div>

        <div class="col-6 col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" type="submit" asp-page-handler="Preview">Genera preview</button>
        </div>

        <div class="col-6 col-md-3 d-flex align-items-end">
            <button type="button"
                    class="btn btn-danger w-100"
                    id="btnOpenSendModal">
                INVIA ORDINE
            </button>

            <button type="submit"
                    class="d-none"
                    id="btnSendHidden"
                    asp-page-handler="Send">
            </button>
        </div>

    </div>
</form>


@if (Model.Rows?.Any() == true)
{
    <!-- =========================
         MOBILE: CARDS
         ========================= -->
    <div class="bf-preview-mobile d-md-none">
        @foreach (var r in Model.Rows)
        {
            <div class="bf-preview-card">
                <div class="bf-preview-top">
                    <div>
                        <div class="bf-preview-name">@r.DisplayName</div>
                        <div class="mt-2">
                            @{
                                var s = (r.Status ?? "").ToUpperInvariant();
                                var isOk = s.Contains("OK") || s.Contains("SUCCESS") || s.Contains("PREVIEW OK");
                                var isWarn = s.Contains("INSUFFICIENT") || s.Contains("MIN") || s.Contains("LIABILITY") || s.Contains("SUPERIORE");
                                var cls = isOk ? "bg-success" : (isWarn ? "bg-warning text-dark" : "bg-danger");
                            }
                            <span class="badge @cls">@r.Status</span>
                        </div>
                    </div>

                    <div class="text-end">
                        @if (r.MinStakeApplied)
                        {
                            <span class="badge bg-warning text-dark">Min 1€: SI</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Min 1€: NO</span>
                        }
                    </div>
                </div>

                <div class="bf-kv">
                    <div class="bf-kv-row">
                        <div class="bf-k">Saldo</div>
                        <div class="bf-v">@(r.Balance?.ToString("0.00") ?? "-")</div>
                    </div>
                    <div class="bf-kv-row">
                        <div class="bf-k">Stake/Importo</div>
                        <div class="bf-v">@(r.Stake?.ToString("0.00") ?? "-")</div>
                    </div>
                    <div class="bf-kv-row">
                        <div class="bf-k">Liability (LAY)</div>
                        <div class="bf-v">@(r.Liability?.ToString("0.00") ?? "-")</div>
                    </div>
                    <div class="bf-kv-row">
                        <div class="bf-k">BetId</div>
                        <div class="bf-v">@(r.BetId ?? "-")</div>
                    </div>
                </div>

                <div class="bf-preview-actions">
                    @if (!string.IsNullOrWhiteSpace(r.BetId))
                    {
                        <button type="button"
                                class="btn btn-outline-danger btn-cancel"
                                data-account="@r.DisplayName"
                                data-betid="@r.BetId">
                            Cancella ordine
                        </button>
                    }

                    @if (!string.IsNullOrWhiteSpace(r.JsonRpcPreview))
                    {
                        <details class="bf-preview-json">
                            <summary class="mt-1">JSON-RPC preview</summary>
                            <pre>@r.JsonRpcPreview</pre>
                        </details>
                    }
                </div>
            </div>
        }
    </div>

    <!-- =========================
         DESKTOP/TABLET: TABELLA
         ========================= -->
    <div class="bf-preview-table d-none d-md-block">
        <table class="table">
            <thead>
                <tr>
                    <th>Account</th>
                    <th>Saldo</th>
                    <th>Stake/Importo</th>
                    <th>Liability (LAY)</th>
                    <th>Min 1€</th>
                    <th>Stato</th>
                    <th>BetId</th>
                    <th>Live</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model.Rows)
                {
                    <tr>
                        <td>@r.DisplayName</td>
                        <td>@(r.Balance?.ToString("0.00") ?? "-")</td>
                        <td>@(r.Stake?.ToString("0.00") ?? "-")</td>
                        <td>@(r.Liability?.ToString("0.00") ?? "-")</td>
                        <td>
                            @if (r.MinStakeApplied)
                            {
                                <span class="badge bg-warning text-dark">SI</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">NO</span>
                            }
                        </td>
                        <td>
                            @{
                                var s = (r.Status ?? "").ToUpperInvariant();
                                var isOk = s.Contains("OK") || s.Contains("SUCCESS") || s.Contains("PREVIEW OK");
                                var isWarn = s.Contains("INSUFFICIENT") || s.Contains("MIN") || s.Contains("LIABILITY") || s.Contains("SUPERIORE");
                                var cls = isOk ? "bg-success" : (isWarn ? "bg-warning text-dark" : "bg-danger");
                            }
                            <span class="badge @cls">@r.Status</span>
                        </td>

                        <td>@(r.BetId ?? "-")</td>

                        <td>
                            @if (!string.IsNullOrWhiteSpace(r.BetId))
                            {
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger btn-cancel"
                                        data-account="@r.DisplayName"
                                        data-betid="@r.BetId">
                                    Cancella ordine
                                </button>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                    </tr>

                    @if (!string.IsNullOrWhiteSpace(r.JsonRpcPreview))
                    {
                        <tr>
                            <td colspan="8">
                                <details>
                                    <summary>JSON-RPC preview (@r.DisplayName)</summary>
                                    <pre class="mt-2">@r.JsonRpcPreview</pre>
                                </details>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
}


<a class="btn btn-secondary" asp-page="/Funds">Indietro</a>
<div class="modal fade" id="sendConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down">
        <div class="modal-content shadow text-dark">
            <div class="modal-header">
                <div class="bank-header">
                    <span class="ball">⚽</span>
                    <h5 class="modal-title mb-0">Conferma invio ordine</h5>
                </div>

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>

            <div class="modal-body text-dark">
                <div class="risk-box mb-3">
                    <strong>Stai per inviare un ordine REALE</strong> su <strong>tutti</strong> gli account collegati.
                    <div class="small mt-1">
                        Controlla bene i dati qui sotto prima di confermare.
                    </div>
                </div>


                <div class="bank-summary">
                    <div class="bank-row">
                        <div class="bank-k">Evento</div>
                        <div class="bank-v" id="mEventName">-</div>
                    </div>

                    <div class="bank-row">
                        <div class="bank-k">Selezione</div>
                        <div class="bank-v" id="mRunnerName">-</div>
                    </div>

                    <div class="bank-row">
                        <div class="bank-k">Tipo</div>
                        <div class="bank-v">
                            <span id="mSideBadge" class="badge-side badge-back">BACK</span>
                        </div>
                    </div>

                    <div class="bank-row">
                        <div class="bank-k">Quota</div>
                        <div class="bank-v" id="mPrice">-</div>
                    </div>

                    <div class="bank-row">
                        <div class="bank-k">Stake % (LAY)</div>
                        <div class="bank-v" id="mStakePercent">-</div>
                    </div>

                    <div class="bank-row">
                        <div class="bank-k">Importo € (BACK)</div>
                        <div class="bank-v" id="mBackEuro">-</div>
                    </div>
                </div>



                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="chkFinalConfirm">
                    <label class="form-check-label" for="chkFinalConfirm">
                        Ho capito: voglio inviare davvero l’ordine
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Annulla
                </button>

                <button type="button" class="btn btn-danger" id="btnConfirmSend" disabled>
                    Sì, invia ordine
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function toggleSideFields() {
            const side = (document.getElementById("sideSelect")?.value || "LAY").toUpperCase();
            const grpStake = document.getElementById("grpStakePercent");
            const grpBack = document.getElementById("grpBackStakeEuro");

            const inpPct = document.querySelector('input[name="StakePercent"]');
            const inpBack = document.querySelector('input[name="BackStakeEuro"]');

            if (!grpStake || !grpBack) return;

            const isLay = side === "LAY";

            grpStake.style.display = isLay ? "" : "none";
            grpBack.style.display = isLay ? "none" : "";

            // Disabilita il campo non usato così non viene postato
            if (inpPct) inpPct.disabled = !isLay;
            if (inpBack) inpBack.disabled = isLay;

            // required coerente
            if (inpPct) inpPct.required = isLay;
            if (inpBack) inpBack.required = !isLay;

            // Reset valori per UI “pulita”
            if (isLay) {
                if (inpBack) inpBack.value = "";
            } else {
                if (inpPct) inpPct.value = "";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            toggleSideFields();
            document.getElementById("sideSelect")?.addEventListener("change", toggleSideFields);
        });

        (async function () {
            function getAntiForgeryToken() {
                const el = document.querySelector('input[name="__RequestVerificationToken"]');
                return el ? el.value : "";
            }

            async function cancelOrder(account, betId) {
                const token = getAntiForgeryToken();

                const form = new URLSearchParams();
                form.append("account", account);
                form.append("betId", betId);

                const res = await fetch(`/OrderPreview?handler=CancelOrder`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "RequestVerificationToken": token
                    },
                    body: form.toString()
                });

                return await res.json();
            }

            function bindCancelButtons() {
                document.querySelectorAll(".btn-cancel").forEach(btn => {
                    if (btn.dataset.bound === "1") return;
                    btn.dataset.bound = "1";

                    btn.addEventListener("click", async () => {
                        const account = btn.dataset.account;
                        const betId = btn.dataset.betid;

                        if (!confirm(`Confermi cancellazione ordine?\nAccount: ${account}\nBetId: ${betId}`))
                            return;

                        btn.disabled = true;
                        try {
                            const data = await cancelOrder(account, betId);
                            if (!data.ok) {
                                alert(data.error || "Errore cancellazione");
                                return;
                            }

                            // opzionale: dopo cancel, ricarica pagina per aggiornare tabella
                            location.reload();
                        } finally {
                            btn.disabled = false;
                        }
                    });
                });
            }

            bindCancelButtons();
        })();
                // ===== Modal invio ordine (Bootstrap) =====
        const btnOpen = document.getElementById("btnOpenSendModal");
        const btnHidden = document.getElementById("btnSendHidden");
        const modalEl = document.getElementById("sendConfirmModal");
        const chk = document.getElementById("chkFinalConfirm");
        const btnConfirm = document.getElementById("btnConfirmSend");

        function valOf(name) {
            const el = document.querySelector(`[name="${name}"]`);
            return el ? (el.value || "").trim() : "";
        }

         function fillModalSummary() {
            // Evento: titolo pagina (qui non abbiamo il vero nome match, quindi usiamo titolo)
            const eventTitle =
                document.querySelector("h1")?.textContent ||
                document.querySelector(".ns-title")?.textContent ||
                "Evento";

            // Runner: testo selezionato nella select
            const sel = document.querySelector('select[name="SelectionId"]');
            const runnerText = sel?.selectedOptions?.[0]?.textContent || "-";

            // Riempimento campi visivi
            const evEl = document.getElementById("mEventName");
            const runEl = document.getElementById("mRunnerName");
            if (evEl) evEl.textContent = "-";
            if (runEl) runEl.textContent = runnerText.trim();

            const priceEl = document.getElementById("mPrice");
            const stakePctEl = document.getElementById("mStakePercent");
            const backEuroEl = document.getElementById("mBackEuro");

            if (priceEl) priceEl.textContent = valOf("Price") || "-";
            if (stakePctEl) stakePctEl.textContent = valOf("StakePercent") || "-";
            if (backEuroEl) backEuroEl.textContent = valOf("BackStakeEuro") || "-";

            // ===== PUNTO 4: Badge BACK/LAY colorato =====
            const side = (valOf("Side") || "").toUpperCase();
            const badge = document.getElementById("mSideBadge");
            if (badge) {
                badge.classList.remove("badge-back", "badge-lay");

                if (side === "LAY") {
                    badge.classList.add("badge-lay");
                    badge.textContent = "LAY";
                } else {
                    badge.classList.add("badge-back");
                    badge.textContent = "BACK";
                }
            }

            // reset check (sempre)
            if (chk) chk.checked = false;
            if (btnConfirm) btnConfirm.disabled = true;

            // ===== PUNTO 5: Anti-errore (blocca invio se manca qualcosa) =====
            const marketIdOk = !!valOf("MarketId");
            const selectionOk = !!(sel?.value || valOf("SelectionId"));
            const priceOk = !!valOf("Price");

            const canProceed = marketIdOk && selectionOk && priceOk;

            // Se manca qualcosa, non permettere comunque conferma
            if (!canProceed) {
                if (chk) chk.checked = false;
                if (btnConfirm) btnConfirm.disabled = true;
            }
        }

                async function loadTeamsIntoModal() {
            const marketId = valOf("MarketId");
            const evEl = document.getElementById("mEventName");
            if (!evEl) return;

            if (!marketId) {
                evEl.textContent = "-";
                return;
            }

            try {
                // Mostro un testo temporaneo mentre carica
                evEl.textContent = "Caricamento…";

                const url = `/OrderPreview?handler=MarketInfo&marketId=${encodeURIComponent(marketId)}`;
                const res = await fetch(url, { cache: "no-store" });
                const data = await res.json();

                if (!data.ok) {
                    evEl.textContent = "-";
                    return;
                }

                const home = (data.homeTeam || "").trim();
                const away = (data.awayTeam || "").trim();

                if (home && away) {
                    evEl.textContent = `${home} vs ${away}`;
                } else {
                    // fallback se non riesce lo split
                    evEl.textContent = (data.eventName || "-").trim();
                }
            } catch {
                evEl.textContent = "-";
            }
        }


            if (btnOpen && modalEl) {
        const bsModal = new bootstrap.Modal(modalEl);

        btnOpen.addEventListener("click", async () => {
            fillModalSummary();
            bsModal.show();

            // dopo l'apertura, carico le squadre vere dal server
            await loadTeamsIntoModal();
        });


            if (chk && btnConfirm) {
                chk.addEventListener("change", () => {
                    btnConfirm.disabled = !chk.checked;
                });
            }

            if (btnConfirm && btnHidden) {
                btnConfirm.addEventListener("click", () => {
                    // evita doppi click
                    btnConfirm.disabled = true;
                    btnConfirm.textContent = "Invio in corso...";

                    // invia davvero
                    btnHidden.click();
                });
            }
        }

    </script>
}
